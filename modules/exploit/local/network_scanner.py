import socket
from datetime import datetime
import sys, time
from colorama import Fore
import colorama
colorama.init()
if len(sys.argv) < 5:
    exit()

ip_address = sys.argv[1]
splitted_ip_digits = ip_address.split('.')
dot = '.'

first_three_ip_digits = splitted_ip_digits[0] + dot + splitted_ip_digits[1] + dot + splitted_ip_digits[2] + dot
starting_number = int(sys.argv[2])
ending_number = int(sys.argv[3])
port_opened = int(sys.argv[4])
if port_opened > 65300:
    print(Fore.BLUE+'[*]'+Fore.RESET+" Port 65300'den fazla, bunun yerine 135 numaralı bağlantı noktasını kullanarak...")
    port_opened = 135
ending_number = ending_number + 1
start_time = datetime.now()
start_time = start_time.strftime("%H:%M:%S")
print(Fore.BLUE+'[*]'+Fore.RESET+f' {ip_address} Taranıyor, Canlı (yanıt veren) cihazlar için...')
print(Fore.BLUE+'[*]'+Fore.RESET+' Açılan bağlantı noktası için tarama:', port_opened)
time.sleep(1)
devices = 0
devs = ''''''
hostnames = ''''''
port_names = ''''''
def scan(ip_address):
    global devices
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        socket.setdefaulttimeout(1)
        # sys.stdout.write(Fore.BLUE+'\r[*]'+Fore.RESET+' Searching And Scanning:', ip_address)
        result = sock.connect_ex((ip_address, port_opened))
        if result == 0:
            devices += 1
            return 1
        else:
            return 0
    except KeyboardInterrupt:
        print('')
        print(Fore.RED+'[-]'+Fore.RESET+' Klavye kesintisi, tarama yapıldı')
        sys.exit()

def execute():
    global devs, hostnames, port_names
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    devs = '''
----------------------------------------------
| IP Adresler                                |
----------------------------------------------'''
    hostnames = '''
----------------------------------------------
| IP adresleriyle ana bilgisayar adı         |
----------------------------------------------'''
    port_names = '''
----------------------------------------------
| IP adresi ile bağlantı noktası hizmetleri  |
----------------------------------------------'''
    for ip in range(starting_number, ending_number):
        ip_address = first_three_ip_digits + str(ip)
        # sys.stdout.write(Fore.BLUE+'\r[*]'+Fore.RESET+' Searching And Scanning: '+str(ip_address))
        sys.stdout.write(Fore.YELLOW+'\r[+]'+Fore.RESET+' Cihazlar bulundu: '+str(devices))
        if (scan(ip_address)):
            sys.stdout.write(Fore.YELLOW+'\r[+]'+Fore.RESET+' Cihazlar bulundu: '+str(devices))
            # sys.stdout.write(Fore.BLUE+'\r[*]'+Fore.RESET+' Searching And Scanning:', ip_address)
            # sys.stdout.write(" "+ip_address+"       True (Yes)")
            name = socket.gethostbyaddr(ip_address)
            port = socket.getservbyport(port_opened)
            if name[0] == '' or name[0] == ' ':
                name = ['Tespit edilmedi', 'Ana bilgisayar adı yok']
            if port == '' or port == [''] or port == '\n':
                port = "Tespit edilmedi"
            devs += "\n "+ip_address
            hostnames += "\n "+ip_address+"   -   "+name[0]
            port_names += "\n "+ip_address+"   -   "+port
    if devices == 0:
        print(Fore.RED+'\r[-]'+Fore.RESET+' Tarama tamamlandı, ancak cihazlar bulunamadı!')
        sys.exit()
    else:
        sys.stdout.write(Fore.YELLOW+"\r[+]"+Fore.RESET+" Tarama tamamlandı! Cihazlar bulundu: "+str(devices))

execute()
end_time = datetime.now()
end_time = end_time.strftime("%H:%M:%S")
# start_time = start_time.strftime("%H:%M:%S")
# total_time = int(end_time) - int(start_time)
print(devs)
print('')
print(hostnames)
print('')
print(port_names)
print('')